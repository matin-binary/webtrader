define(["exports","jquery","websockets/binary_websockets","navigation/menu","charts/chartWindow","../common/marketUtils","jquery-growl","common/util"],function(e,t,a,n,r,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getSpecificMarketData=e.isMarketDataPresent=e.getMarketData=e.init=void 0;var u=l(t),i=l(a),o=l(n),m=l(r);function l(e){return e&&e.__esModule?e:{default:e}}function c(){i.default.send({active_symbols:"brief"}).then(function(e){var r=[];local_storage.set("active_symbols",e.active_symbols);var t=_(e.active_symbols).groupBy("market").map(function(e){var t=e,a=_.head(t),n={name:a.market,display_name:a.market_display_name};return n.submarkets=_(t).groupBy("submarket").map(function(e){var t=_.head(e),a={name:t.submarket,display_name:t.submarket_display_name,subgroup_name:t.subgroup_display_name,subgroup:t.subgroup};return a.instruments=_.map(e,function(e){return r.push(e.symbol),{symbol:e.symbol,display_name:e.display_name}}),a}).value(),n}).value();g=p.map(function(e){return{display_name:e.display_name,name:e.name,submarkets:e.submarkets.map(function(e){return{display_name:e.display_name,instruments:e.instruments.filter(function(e){return-1!==r.indexOf(e.symbol)})}}).filter(function(e){return 0!==e.instruments.length})}}).filter(function(e){return 0!==e.submarkets.length}),g=(0,s.getSortedMarketSubmarkets)(t);var a=(0,u.default)("#nav-menu").find(".instruments");a.find("> ul").remove(),o.default.refreshMenu(a,g,f)}).catch(function(e){u.default.growl.error({message:e.message})})}function d(){local_storage.get("oauth")?i.default.cached.authorize().then(function(){var e=local_storage.get("authorize").country;i.default.cached.send({landing_company:e}).then(function(e){e.landing_company;c()})}).catch(function(e){u.default.growl.error({message:e.message})}):c()}function f(e,t){m.default.addNewWindow({instrumentCode:e,instrumentName:t,timePeriod:"1d",type:"candlestick"})}var g=[],p=[],k=e.init=function(){return i.default.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(e){return p=o.default.extractChartableMarkets(e),d(),i.default.events.on("login",d),i.default.events.on("logout",d),p})},y=e.getMarketData=function(){return g},b=e.isMarketDataPresent=function(a,e){var n=!1;e=e||g;var r=this;return u.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.isMarketDataPresent(a,t.submarkets||t.instruments):u.default.trim(t.display_name)==u.default.trim(a)&&(n=!0),!n}),n},h=e.getSpecificMarketData=function(a,e){var n={};e=e||g;var r=this;return u.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.getSpecificMarketData(a,t.submarkets||t.instruments):u.default.trim(t.display_name)==u.default.trim(a)&&(n=t),u.default.isEmptyObject(n)}),n};e.default={init:k,getMarketData:y,isMarketDataPresent:b,getSpecificMarketData:h}});